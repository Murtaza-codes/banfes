<!-- templates/assignment/assignment_form.html -->
{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load i18n %}
{% load custom_filters %}

{% block content %}

<!-- Breadcrumb Navigation -->
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb bg-light p-2 rounded">
        <li class="breadcrumb-item"><a href="{% url 'home' %}">{% trans 'Home' %}</a></li>
        <li class="breadcrumb-item"><a href="{% url 'programs' %}">{% trans 'Programs' %}</a></li>
        <li class="breadcrumb-item"><a href="{{ course.get_absolute_url }}">{{ course }}</a></li>
        <li class="breadcrumb-item"><a href="{% url 'assignment_list' course.slug %}">{% trans 'Assignments' %}</a></li>
        {% if object %}
            <li class="breadcrumb-item active" aria-current="page">{% trans 'Edit Assignment' %}</li>
        {% else %}
            <li class="breadcrumb-item active" aria-current="page">{% trans 'Create Assignment' %}</li>
        {% endif %}
    </ol>
</nav>

<!-- Page Title -->
{% if object %}
    <h1 class="mb-4">{% trans 'Edit Assignment' %}</h1>
{% else %}
    <h1 class="mb-4">{% trans 'Create Assignment' %}</h1>
{% endif %}

<div class="container">
    <form method="post" enctype="multipart/form-data" id="assignment-form">
        {% csrf_token %}
        {{ form.non_field_errors }}

        <input type="hidden" name="evaluation_criteria_path" id="evaluation_criteria_path" value="">
        <input type="hidden" name="additional_file_path" id="additional_file_path" value="">

        <!-- Assignment Type Field -->
        <div class="mb-3">
            {{ form.assignment_type.label_tag }}
            {{ form.assignment_type|add_class:"form-select" }}
            {{ form.assignment_type.errors }}
        </div>

        <!-- Title Field -->
        <div class="mb-3">
            {{ form.title|as_crispy_field }}
        </div>

        <!-- Description Field -->
        <div class="mb-3">
            {{ form.description|as_crispy_field }}
        </div>

        <!-- Evaluation Criteria Field -->
        <div class="mb-3" id="evaluation-criteria-field">
            <label for="evaluation_criteria_file" class="form-label">{{ form.evaluation_criteria.label }}</label>
            <input type="file" id="evaluation_criteria_file" name="evaluation_criteria_file" class="form-control">
            {{ form.evaluation_criteria.errors }}
            
            {% if object and object.evaluation_criteria %}
                <div class="mt-3 mb-3 text-primary bg-light p-2 border border-primary">
                    <strong>{% trans 'Current Evaluation Criteria:' %}</strong>
                    <a class="btn btn-success btn-sm" href="{{ object.evaluation_criteria.url }}" target="_blank">{% trans 'View File' %}</a>
                </div>
            {% endif %}
            <div class="mt-2 mt-3 mb-3 text-primary bg-light p-2" id="uploaded_evaluation_criteria_files"></div>
        </div>

        <!-- Deadline Field -->
        <div class="mb-3">
            {{ form.deadline|as_crispy_field }}
        </div>

        <!-- Allowed Submissions Field -->
        <div class="mb-3" id="allowed-submissions-field">
            {{ form.allowed_submissions|as_crispy_field }}
            {{ form.allowed_submissions.errors }}
        </div>

        <!-- Status Field -->
        <div class="mb-3">
            {{ form.status.label_tag }}
            {{ form.status|add_class:"form-select" }}
            {{ form.status.errors }}
        </div>

        <!-- Additional File Field -->
        <div class="mb-3">
            <label for="additional_file_file" class="form-label">{{ form.additional_file.label }}</label>
            <input type="file" id="additional_file_file" name="additional_file_file" class="form-control">
            {{ form.additional_file.errors }}
            
            {% if object and object.additional_file %}
                <div class="mt-3 mb-3 text-primary bg-light p-2 border border-primary">
                    <strong>{% trans 'Current Additional File:' %}</strong>
                    <a class="btn btn-success btn-sm" href="{{ object.additional_file.url }}" target="_blank">{% trans 'View File' %}</a>
                </div>
                <button class="btn btn-danger btn-sm" id="delete-additional-file-button" name={{object.additional_file.name}} value="{{ object.additional_file.path }}">
                    {% trans "Delete" %}
                </button>
            {% endif %}
            <div class="mt-2 mt-3 mb-3 text-primary bg-light p-2" id="uploaded_additional_files"></div>
        </div>

        <!-- Submit Button -->
        <button type="submit" class="btn btn-success">
            {% if object %}
                {% trans 'Update Assignment' %}
            {% else %}
                {% trans 'Create Assignment' %}
            {% endif %}
        </button>
    </form>
</div>

<!-- Progress Bars and JavaScript -->
<div class="container mt-4">
    <div id="upload-progress-eval" class="progress mb-3" style="height: 25px; display: none;">
        <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
    </div>
    <div id="upload-progress-additional" class="progress mb-3" style="height: 25px; display: none;">
        <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
    </div>
</div>

<!-- JavaScript to Handle AJAX File Uploads -->
<script>
    document.addEventListener('DOMContentLoaded', function() {

    const assignmentTypeField = document.getElementById('{{ form.assignment_type.id_for_label }}');
    const allowedSubmissionsField = document.getElementById('allowed-submissions-field');
    // first check if the field exists
    

    let deleteAdditionalFileButton = null;
    if(document.getElementById('delete-additional-file-button')){

        deleteAdditionalFileButton = document.getElementById('delete-additional-file-button');
        
        deleteAdditionalFileButton.addEventListener('click', function() {
        
        // show a confirmation modal and check if the user wants to delete the file
        if (!confirm('Are you sure you want to delete this file?')) {
            return;
        }    
        deleteAdditionalFile(deleteAdditionalFileButton);
        });
    }

    function deleteAdditionalFile(button) {
        // Validate that a file is selected
        if (!button.value) {
            alert('Please select a file to delete.');
            return;
        }

        // Send an AJAX request to delete the file
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        formData.append('file_path', button.value);
        formData.append('assignment_id', '{{ object.id }}');

        const xhr = new XMLHttpRequest();
        xhr.open('POST', '{% url "ajax_delete_file" %}', true);
        
        xhr.onload = function() {
            if (xhr.status === 200) {
                const response = JSON.parse(xhr.responseText);
                if (response.error) {
                    alert(response.error);
                } else {
                    const uploadedFilesContainer = document.getElementById('uploaded_additional_files');
                    uploadedFilesContainer.innerHTML = '';
                }
            } else {
                alert('An error occurred while deleting the file.');
            }
        }

        xhr.onerror = function() {
            alert('An error occurred while deleting the file.');
        }

        xhr.send(formData);
    }




    function toggleFields() {
        const selectedType = assignmentTypeField.value;

        // Toggle Allowed Submissions Field
        if (selectedType === 'project') {  // Adjust based on your assignment types
            allowedSubmissionsField.style.display = 'none';
        } else {
            allowedSubmissionsField.style.display = 'block';
        }
    }

    // Initial toggle on page load
    toggleFields();

    assignmentTypeField.addEventListener('change', toggleFields);


    // Function to handle AJAX file uploads
    function uploadFile(fileInput, progressBarId, uploadedFilesContainerId, hiddenInputId) {
        
        const file = fileInput.files[0];

        if (!file) return;

        // Validate file size (max 15MB) 
        if (file.size > 15 * 1024 * 1024) {  // 15MB
            alert('File size must not exceed 15MB.');
            fileInput.value = '';  // Clear the input
            return;
        }

        const formData = new FormData();
        formData.append('file', file);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        formData.append('field_name', hiddenInputId);

        const xhr = new XMLHttpRequest();

        xhr.open('POST', '{% url "ajax_upload_file" %}', true);

        // Show and reset the progress bar
        const progressBar = document.getElementById(progressBarId);
        progressBar.style.display = 'block';
        progressBar.querySelector('.progress-bar').style.width = '0%';
        progressBar.querySelector('.progress-bar').innerText = '0%';

        // Update progress bar
        xhr.upload.onprogress = function(event) {
            if (event.lengthComputable) {
                const percentComplete = Math.round((event.loaded / event.total) * 100);
                progressBar.querySelector('.progress-bar').style.width = percentComplete + '%';
                progressBar.querySelector('.progress-bar').innerText = percentComplete + '%';
            }
        };

        // On successful upload
        xhr.onload = function() {
            if (xhr.status === 200) {
                const response = JSON.parse(xhr.responseText);
                if (response.error) {
                    alert(response.error);
                    progressBar.style.display = 'none';
                    fileInput.value = '';
                } else {
                    // Update the hidden input with the file path
                    const hiddenInput = document.getElementById(response.field_name);
                    hiddenInput.value = response.file_path;

                    // Display the uploaded file
                    const uploadedFilesContainer = document.getElementById(uploadedFilesContainerId);
                    uploadedFilesContainer.innerHTML = '';  // Clear previous content

                    const fileDiv = document.createElement('div');
                    fileDiv.classList.add('uploaded-file', 'mb-2');

                    const fileLink = document.createElement('a');
                    fileLink.href = response.file_url;
                    fileLink.target = '_blank';
                    fileLink.innerText = response.file_name;
                    fileDiv.appendChild(fileLink);

                    // Add a delete button
                    const deleteBtn = document.createElement('button');
                    deleteBtn.type = 'button';
                    deleteBtn.classList.add('btn', 'btn-danger', 'btn-sm', 'ms-2');
                    deleteBtn.innerText = 'Delete';
                    deleteBtn.addEventListener('click', function() {
                        if (confirm('Are you sure you want to delete this file?')) {
                            deleteFile(response.file_path, uploadedFilesContainer, hiddenInput);
                        }
                    });
                    fileDiv.appendChild(deleteBtn);

                    uploadedFilesContainer.appendChild(fileDiv);

                    // Hide the progress bar
                    progressBar.style.display = 'none';

                    // Clear the file input
                    fileInput.value = '';
                }
            } else {
                alert('An error occurred during the upload.');
                progressBar.style.display = 'none';
            }
        };

        // Handle network errors
        xhr.onerror = function() {
            alert('An error occurred during the upload.');
            progressBar.style.display = 'none';
        };

        xhr.send(formData);
    }

    // Function to handle AJAX file deletion
    function deleteFile(filePath, uploadedFilesContainer, hiddenInput) {
        const formData = new FormData();
        formData.append('file_path', filePath);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        const xhr = new XMLHttpRequest();
        xhr.open('POST', '{% url "ajax_delete_file" %}', true);

        xhr.onload = function() {
            if (xhr.status === 200) {
                const response = JSON.parse(xhr.responseText);
                if (response.error) {
                    alert(response.error);
                } else {
                    // Clear the uploaded files container and hidden input
                    uploadedFilesContainer.innerHTML = '';
                    hiddenInput.value = '';
                }
            } else {
                alert('An error occurred while deleting the file.');
            }
        };

        xhr.onerror = function() {
            alert('An error occurred while deleting the file.');
        };

        xhr.send(formData);
    }

    // Handle Evaluation Criteria file upload
    const evalFileInput = document.getElementById('evaluation_criteria_file');
    evalFileInput.addEventListener('change', function() {
        uploadFile(
            evalFileInput,
            'upload-progress-eval',
            'uploaded_evaluation_criteria_files',
            'evaluation_criteria_path'
        );
    });

    // Handle Additional File upload
    const additionalFileInput = document.getElementById('additional_file_file');
    additionalFileInput.addEventListener('change', function() {
        uploadFile(
            additionalFileInput,
            'upload-progress-additional',
            'uploaded_additional_files',
            'additional_file_path'
        );
    });
});
</script>

{% endblock %}